/**
 * Implementation library for e-Retail DX
 * --------------------------------------
 * For Amadeus usage only. Usage of methods by any other party is discouraged and not supported.
 * 
 * @copyright Amadeus Implementation Team
 */
function IMPLibDxPlusGrade(){var self=this;this.VERSION="1.4",this._parseDate=function(e){var t=Date.parse(e);return isNaN(t)?aria.utils.Date.interpret(e):new Date(t)},this._formatDate=function(e){return plnextv2.utils.DateUtils.formatDate(self._parseDate(e),"yyyy-MM-dd")},this._formatTime=function(e){return plnextv2.utils.DateUtils.formatDate(self._parseDate(e),"HH:mm")},this._getData=function(){return plnextv2.utils.context.AppContext.getPageData().business},this._safeAssign=function(obj,field,fn,isMandatory){try{var result=eval(fn);null!=result?obj[field]=result:isMandatory&&(obj[field]="")}catch(e){implibdx.core.debug(eval+" value not found: "+e.message),isMandatory&&(obj[field]="")}},this._hasPgInfant=function(){for(var e=self._getData(),t=0;t<e.TRAVELLER_REVIEW.travellerListBean.Travellers;t++)if(e.TRAVELLER_REVIEW.travellerListBean.Travellers[t].Infants.length>0)return!0;return!1},this._getPgFlights=function(){for(var e=[],t=self._getData(),a=0;a<t.FareReview.tripSummary.listItinerary.listItineraryElem.length;a++)for(var i=t.FareReview.tripSummary.listItinerary.listItineraryElem[a],r=0;r<i.listSegment.length;r++){var s=i.listSegment[r],l={carrierCode:s.airline.code,departureDate:self._formatDate(s.beginDate),departureTime:self._formatTime(s.beginDate),origination:s.beginLocation.locationCode,destination:s.endLocation.locationCode,fareClass:s.listCabin[0].listRbd[0].rbd,flightNumber:s.flightNumber};e.push(l)}return e},this._getPgTicketingDate=function(){var e=self._getData();if(e.RESERVATION_INFO.listAirTicket)for(var t=0;t<e.RESERVATION_INFO.listAirTicket.length;t++){var a=e.RESERVATION_INFO.listAirTicket[t];if(a.faFh.latest)return self._formatDate(a.faFh.issueDate)}return null},this._getPgTickets=function(){var e=self._getData(),t={},a=[];if(e.RESERVATION_INFO.listAirTicket){for(var i=0;i<e.RESERVATION_INFO.listAirTicket.length;i++){var r=e.RESERVATION_INFO.listAirTicket[i].faFh;if(r.latest){var s={firstName:null,lastName:null,primaryTraveller:1==r.liTravellerId[0],ticketNumber:r.documentNumber};t[r.liTravellerId[0]]=s}}for(var i=0;i<e.RESERVATION_INFO.liTravellerInfo.length;i++){var l=e.RESERVATION_INFO.liTravellerInfo[i],s=t[l.travellerId];null!=s&&(s.firstName=l.identity.firstName,s.lastName=l.identity.lastName,a.push(s))}}return a},this._getPgPointOfSale=function(){var e=self._getData();return e.FareReview.tripSummary.listItinerary.listItineraryElem[0].listSegment[0].beginLocation.countryCode.toUpperCase()},this._getPgLanguage=function(){return aria.core.AppEnvironment.applicationSettings.language.primaryLanguage+"_"+aria.core.AppEnvironment.applicationSettings.language.region},this._createPgOfferingObject=function(){self._getData();try{var e={};return self._safeAssign(e,"pnr","self._getData().RESERVATION_INFO.locator",!0),self._safeAssign(e,"firstName","self._getData().RESERVATION_INFO.liTravellerInfo[0].identity.firstName",!0),self._safeAssign(e,"lastName","self._getData().RESERVATION_INFO.liTravellerInfo[0].identity.lastName",!0),self._safeAssign(e,"pax","self._getData().RESERVATION_INFO.liTravellerInfo.length",!0),self._safeAssign(e,"language","self._getPgLanguage()",!0),self._safeAssign(e,"pointOfSale","self._getPgPointOfSale()",!0),self._safeAssign(e,"flights","self._getPgFlights()",!0),self._safeAssign(e,"currency","self._getData().Price.totalAmount.currency.code",!0),self._safeAssign(e,"email","self._getData().FareReview.contactInformation.Email",!1),self._safeAssign(e,"mobilePhone","self._getData().FareReview.contactInformation.PhoneMobile",!1),self._safeAssign(e,"infant","self._hasPgInfant()",!1),self._safeAssign(e,"totalFarePaid","self._getData().Price.totalAmount.amount",!1),self._safeAssign(e,"loyaltyCompany","self._getData().TRAVELLER_REVIEW.travellerListBean.Travellers[0].FrequentFlyer[0].FREQ_Airline",!1),self._safeAssign(e,"loyaltyNumber","self._getData().TRAVELLER_REVIEW.travellerListBean.Travellers[0].FrequentFlyer[0].FREQ_Number",!1),self._safeAssign(e,"ticketingDate","self._getPgTicketingDate()",!1),self._safeAssign(e,"tickets","self._getPgTickets()",!1),e}catch(t){return implibdx.core.warn("the pg_offering object was not correctly computed: "+t.message),null}},this._getScriptPath=function(e,t){return t?"https://upgrade-stage.plusgrade.com/offer/"+e+"/eligibility/requestInvite.js":"https://upgrade.plusgrade.com/offer/"+e+"/eligibility/requestInvite.js"},this.isTestEnvironment=function(){return!!implibdx.core.getExternalId().match(/pgtest/gi)},this.request=function(e,t,a,i){if(!(implibdx.core.getPage()in t))return void implibdx.core.debug("PlusGrade disabled");var r=!1;"undefined"!=typeof i&&(r=i),implibdx.core.updateDom(a,function(){try{var i=self._createPgOfferingObject();if(null!=i){window.pg_offering=i;var s=self._getScriptPath(e,r),l=t[implibdx.core.getPage()];jQuery.getScript(s,function(){Plusgrade.requestInvite({pg_apiKey:l,success:function(e){e.eligible&&e.html&&jQuery(a).html(e.html)},error:function(e){implibdx.core.warn(e)}})})}}catch(n){implibdx.core.warn("Problem during the init method of plus grade: "+n.message)}},500,60)}}var implibdx=implibdx||{};implibdx.plusGrade=new IMPLibDxPlusGrade;